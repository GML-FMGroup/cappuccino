# Cappuccino é¡¹ç›®æ¶æ„

## ğŸ“‹ é¡¹ç›®ç»“æ„

```
cappuccino/
â”œâ”€â”€ server/                         # æœåŠ¡å±‚ï¼ˆå¯¹å¤–æ¥å£ + ä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ server.py                   # å¤šå¹³å°åè°ƒå™¨ï¼ˆå¯åŠ¨ + é…ç½®ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ commands.py                 # å‘½ä»¤è§£æå’Œè·¯ç”±ï¼ˆè½»é‡ï¼‰
â”‚   â”œâ”€â”€ messages.py                 # ç»Ÿä¸€æ¶ˆæ¯æ–‡æœ¬å®šä¹‰
â”‚   â”œâ”€â”€ handlers.py                 # ä¸šåŠ¡å¤„ç†å±‚ â­ æ ¸å¿ƒåè°ƒè€…
â”‚   â”‚                               # - åŠ è½½ç”¨æˆ·ä¼šè¯è®°å¿† (user memory)
â”‚   â”‚                               # - æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡
â”‚   â”‚                               # - è°ƒç”¨ Agent æ‰§è¡Œä»»åŠ¡
â”‚   â”‚                               # - ä¿å­˜ç”¨æˆ·ä¼šè¯è®°å¿†
â”‚   â”œâ”€â”€ utils.py                    # å·¥å…·å‡½æ•°ï¼ˆSSE ç¼–ç ç­‰ï¼‰
â”‚   â”œâ”€â”€ memory/                     # ä¼šè¯è®°å¿†æ¨¡å—ï¼ˆç”¨æˆ·å¯¹è¯å†å²ï¼‰â­
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ manager.py              # è®°å¿†ç®¡ç†å™¨ï¼ˆåŠ è½½/ä¿å­˜/æ£€ç´¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ storage.py              # å­˜å‚¨åç«¯ï¼ˆSQLiteï¼‰
â”‚   â”‚   â””â”€â”€ context.py              # ä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼ˆæ•´åˆå†å²å¯¹è¯ï¼‰
â”‚   â””â”€â”€ platforms/                  # å¹³å°é€‚é…å±‚ï¼ˆå‡è¡¡çš„æ¶æ„ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ telegram_bot.py         # Telegram Bot (æ¥æ”¶ Telegram API â†’ commands â†’ handlers)
â”‚       â”œâ”€â”€ url_bot.py              # URL/HTTP Bot (æ¥æ”¶ HTTP â†’ commands â†’ handlers)
â”‚       â”œâ”€â”€ discord_bot.py          # Discord Bot (å¾…å®ç°)
â”‚       â””â”€â”€ slack_bot.py            # Slack Bot (å¾…å®ç°)
â”‚
â”‚   â”œâ”€â”€ agent/                       # Agent æ ¸å¿ƒï¼ˆä»»åŠ¡æ‰§è¡Œå¼•æ“ï¼‰â­ é‡æ„
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ agent.py                 # Agent ä¸»æµç¨‹ç¼–æ’ï¼ˆå¾ªç¯æ‰§è¡Œï¼‰
â”‚       â”œâ”€â”€ planner.py               # è§„åˆ’å™¨ï¼ˆç»Ÿä¸€è§„åˆ’å’Œåˆ†å‘åŠŸèƒ½ï¼‰â­ æ ¸å¿ƒ
â”‚       â”œâ”€â”€ executor.py              # æ‰§è¡Œå™¨ï¼ˆé”®é¼ æ“ä½œã€ç­‰å¾…ã€æ»šåŠ¨ç­‰ï¼‰
â”‚       â”œâ”€â”€ memory.py                # ä»»åŠ¡ä¸Šä¸‹æ–‡è®°å¿†ï¼ˆä¸ user memory åˆ†ç¦»ï¼‰
â”‚       â”œâ”€â”€ mcp/                     # MCP (Model Context Protocol) æ¨¡å— â­ åŸºäºå®˜æ–¹SDK
â”‚       â”‚   â”œâ”€â”€ __init__.py          # å¯¼å‡º MCPClientManager, MCPToolCall, MCPToolResult
â”‚       â”‚   â””â”€â”€ client.py            # MCPå®¢æˆ·ç«¯ç®¡ç†å™¨ï¼ˆåŸºäºå®˜æ–¹mcp>=1.6.0 SDKï¼‰
â”‚       â””â”€â”€ utils.py                 # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ config.py                        # ç»Ÿä¸€é…ç½®ç®¡ç†
â”œâ”€â”€ .env                            # ç¯å¢ƒé…ç½®ï¼ˆä¸æäº¤ï¼‰
â”œâ”€â”€ .env.example                    # é…ç½®æ¨¡æ¿
â”œâ”€â”€ pyproject.toml                  # é¡¹ç›®ä¾èµ–
â””â”€â”€ README.md
```

## ğŸ”„ å®Œæ•´è°ƒç”¨é“¾ä¸ Agent æ‰§è¡Œå¾ªç¯

```
â”Œâ”€ Telegram æ¶ˆæ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€ HTTP è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (text/command)              â”‚         â”‚ (/chat, /screenshot)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                                      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ TelegramBotService     â”‚            â”‚ URLBotService          â”‚
  â”‚ (æ¥æ”¶ Telegram API)    â”‚            â”‚ (æ¥æ”¶ HTTP è¯·æ±‚)       â”‚
  â”‚ - æƒé™æ£€æŸ¥             â”‚            â”‚ - Token éªŒè¯           â”‚
  â”‚ - è§£ææ–‡æœ¬æ¶ˆæ¯         â”‚            â”‚ - è§£æè¯·æ±‚ body        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“                                    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Commands å±‚ (commands.py) â­ ç»Ÿä¸€å…¥å£                      â”‚
  â”‚                                                            â”‚
  â”‚ parse_command(text) â†’ (CommandType, arg)                 â”‚
  â”‚                                                            â”‚
  â”‚ â”œâ”€ /start      â†’ handle_start()                          â”‚
  â”‚ â”œâ”€ /help       â†’ handle_help()                           â”‚
  â”‚ â”œâ”€ /screenshot â†’ handle_screenshot()                     â”‚
  â”‚ â””â”€ /run or text â†’ handle_run()                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Handlers å±‚ (handlers.py) â­ ä¸šåŠ¡åè°ƒè€…                    â”‚
  â”‚                                                            â”‚
  â”‚ execute_task(user_id, query, request_config):            â”‚
  â”‚ 1. MemoryManager.load(user_id)      [user memory]        â”‚
  â”‚    â””â†’ åŠ è½½ç”¨æˆ·å†å²å¯¹è¯è®°å¿†                                â”‚
  â”‚ 2. ContextBuilder.build(query, memory)                   â”‚
  â”‚    â””â†’ æ„å»ºåŒ…å«è®°å¿†çš„å®Œæ•´ä¸Šä¸‹æ–‡                            â”‚
  â”‚ 3. Agent(context, mcp_config).execute()                  â”‚
  â”‚    â””â†’ è°ƒç”¨ Agent æ‰§è¡Œï¼ˆå†…éƒ¨å¾ªç¯ï¼‰                        â”‚
  â”‚ 4. MemoryManager.save(user_id, result)  [user memory]    â”‚
  â”‚    â””â†’ ä¿å­˜æœ¬æ¬¡å¯¹è¯åˆ°è®°å¿†                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘ Agent å±‚ (agent.py) â­ ä»»åŠ¡æ‰§è¡Œå¼•æ“ [ç»Ÿä¸€ Planner]         â•‘
  â•‘                                                            â•‘
  â•‘ åˆå§‹åŒ–: TaskContextMemory(task_id, user_query)          â•‘
  â•‘         MCPClientManager (å¼‚æ­¥åˆå§‹åŒ–MCPæœåŠ¡å™¨è¿æ¥) â­     â•‘
  â•‘                                                            â•‘
  â•‘ â”Œâ”€ æ­¥éª¤ 1: Planner.plan() ç”Ÿæˆåˆå§‹è§„åˆ’              â”  â•‘
  â•‘ â”‚ plan = planner.plan(user_query)                     â”‚  â•‘
  â•‘ â”‚ task_memory.user_query = plan                       â”‚  â•‘
  â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
  â•‘                   â†“                                     â•‘  â•‘
  â•‘ â•”â”€ å¼€å§‹å¾ªç¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
  â•‘ â•‘ while iteration < max_iterations:                   â•‘  â•‘
  â•‘ â•‘                                                     â•‘  â•‘
  â•‘ â•‘ â”Œâ”€ Planner.dispatch: æ ¹æ®è§„åˆ’ã€å†å²3ä¸ªåŠ¨ä½œã€å½“å‰æˆªå›¾ â”  â•‘
  â•‘ â•‘ â”‚ action = planner.dispatch(task_memory)           â”‚  â•‘
  â•‘ â•‘ â”‚                                                  â”‚  â•‘
  â•‘ â•‘ â”‚ è¿”å›: {                                          â”‚  â•‘
  â•‘ â•‘ â”‚   "type": "execute|save_info|modify_plan|        â”‚  â•‘
  â•‘ â•‘ â”‚            mcp|reply",  â­ æ–°å¢ mcp ç±»å‹         â”‚  â•‘
  â•‘ â•‘ â”‚   "params": {...}                              â”‚  â•‘
  â•‘ â•‘ â”‚ }                                               â”‚  â•‘
  â•‘ â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
  â•‘ â•‘                   â†“                                  â•‘  â•‘
  â•‘ â•‘ â”Œâ”€ åŠ¨ä½œå¤„ç†                                       â”  â•‘
  â•‘ â•‘ â”‚ if action["type"] == "execute":               â”‚  â•‘
  â•‘ â•‘ â”‚   result = executor.execute(action["params"]) â”‚  â•‘
  â•‘ â•‘ â”‚                                                 â”‚  â•‘
  â•‘ â•‘ â”‚ elif action["type"] == "mcp": â­ æ–°å¢         â”‚  â•‘
  â•‘ â•‘ â”‚   result = mcp_client.call_tool(              â”‚  â•‘
  â•‘ â•‘ â”‚       server, tool, params)                   â”‚  â•‘
  â•‘ â•‘ â”‚                                                 â”‚  â•‘
  â•‘ â•‘ â”‚ elif action["type"] == "save_info":           â”‚  â•‘
  â•‘ â•‘ â”‚   task_memory.save_info(key, value)          â”‚  â•‘
  â•‘ â•‘ â”‚                                                 â”‚  â•‘
  â•‘ â•‘ â”‚ elif action["type"] == "modify_plan":         â”‚  â•‘
  â•‘ â•‘ â”‚   task_memory.set_plan(new_plan)             â”‚  â•‘
  â•‘ â•‘ â”‚                                                 â”‚  â•‘
  â•‘ â•‘ â”‚ elif action["type"] == "reply":              â”‚  â•‘
  â•‘ â•‘ â”‚   # å‘é€å›å¤ç»™ç”¨æˆ·ï¼Œä»»åŠ¡å®Œæˆ                  â”‚  â•‘
  â•‘ â•‘ â”‚   send_reply(message)                         â”‚  â•‘
  â•‘ â•‘ â”‚   break  # ç»“æŸå¾ªç¯                           â”‚  â•‘
  â•‘ â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
  â•‘ â•‘                   â†“                                  â•‘  â•‘
  â•‘ â•‘ â”Œâ”€ æ›´æ–° TaskContextMemory                       â”  â•‘
  â•‘ â•‘ â”‚ task_memory.add_dispatcher_action(             â”‚  â•‘
  â•‘ â•‘ â”‚    action_type,                               â”‚  â•‘
  â•‘ â•‘ â”‚    params,                                    â”‚  â•‘
  â•‘ â•‘ â”‚    result                                     â”‚  â•‘
  â•‘ â•‘ â”‚ )                                             â”‚  â•‘
  â•‘ â•‘ â”‚ (è‡ªåŠ¨ä¿æŒæœ€è¿‘3ä¸ªåŠ¨ä½œ)                         â”‚  â•‘
  â•‘ â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
  â•‘ â•‘                   â†“                                  â•‘  â•‘
  â•‘ â•‘     iteration += 1                                  â•‘  â•‘
  â•‘ â•šâ”€ ç»“æŸå¾ªç¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•  â•‘
  â•‘                   â†“                                     â•‘  â•‘
  â•‘ â”Œâ”€ Reply: å›å¤ç”¨æˆ·æ¶ˆæ¯ â­                           â”  â•‘
  â•‘ â”‚ å½“ Planner è¿”å› reply åŠ¨ä½œæ—¶                     â”‚  â•‘
  â•‘ â”‚ - å‘é€ reply æ¶ˆæ¯ç»™ç”¨æˆ·                          â”‚  â•‘
  â•‘ â”‚ - æ ‡è®° is_complete=True                         â”‚  â•‘
  â•‘ â”‚ â†’ ä»»åŠ¡ç»“æŸ                                       â”‚  â•‘
  â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ è¿”å›æœ€ç»ˆç»“æœ                                              â”‚
  â”‚                                                            â”‚
  â”‚ - å‘å› Telegram æ¶ˆæ¯ (final_message)                       â”‚
  â”‚ - è¿”å› HTTP SSE æµ (final_message)                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ å„å±‚èŒè´£

### Server å±‚ï¼ˆä¸šåŠ¡ + æ¥å£ï¼‰

#### 1. Commands (commands.py)
- **èŒè´£**: å‘½ä»¤è§£æå’Œè·¯ç”±ï¼ˆè½»é‡çº§ï¼‰
- **åŠŸèƒ½**:
  - è§£æå‘½ä»¤ç±»å‹ (/start, /help, /run, /screenshot)
  - å¿«æ·æ“ä½œå‘½ä»¤ç›´æ¥å¤„ç†ï¼ˆstart, help, screenshotï¼‰
  - ä»»åŠ¡å§”æ‰˜ç»™ handlers

#### 2. Handlers (handlers.py) â­ **æ ¸å¿ƒåè°ƒè€…**
- **èŒè´£**: ä¸šåŠ¡é€»è¾‘ç¼–æ’
- **åŠŸèƒ½**:
  - åŠ è½½ç”¨æˆ·ä¼šè¯è®°å¿† (User Memory - å¯¹è¯å†å²)
  - æ„å»ºåŒ…å«å†å²ä¸Šä¸‹æ–‡çš„å®Œæ•´ prompt
  - è°ƒç”¨ Agent æ‰§è¡Œä»»åŠ¡
  - å¤„ç† Agent è¿”å›çš„ reply æ¶ˆæ¯
  - ä¿å­˜ç”¨æˆ·ä¼šè¯è®°å¿†

#### 3. Memory (memory/) - ç”¨æˆ·å¯¹è¯å†å²
- **èŒè´£**: ä¼šè¯è®°å¿†ç®¡ç†ï¼ˆä¸ç”¨æˆ·äº¤äº’çš„å†å²ï¼‰
- **æ¨¡å—**:
  - `manager.py`: è®°å¿†åŠ è½½/ä¿å­˜/æ£€ç´¢æ¥å£
  - `storage.py`: å­˜å‚¨åç«¯å®ç°ï¼ˆSQLiteï¼‰
  - `context.py`: ä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼ˆæ•´åˆå†å²å¯¹è¯ï¼‰

#### 4. Platforms (platforms/)
- **èŒè´£**: å¹³å° API å¯¹æ¥
- **åŠŸèƒ½**: åªç®¡æ”¶å‘æ¶ˆæ¯ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘

### Agent å±‚ï¼ˆä»»åŠ¡æ‰§è¡Œå¼•æ“ï¼‰

#### 1. Agent (agent.py) - ä¸»æµç¨‹ç¼–æ’
- **èŒè´£**: ä»»åŠ¡æ‰§è¡Œå¾ªç¯å’Œåè°ƒ
- **æµç¨‹**: 
  ```
  1. åˆå§‹åŒ– MCP Manager â­ [æ–°å¢]
  2. åˆå§‹è§„åˆ’: Planner.plan() ç”Ÿæˆæ€»ä½“è§„åˆ’
  3. Loop (ç›´åˆ° Planner.dispatch è¿”å› end æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°):
     - Planner.dispatch: æ ¹æ®è§„åˆ’ã€æœ€è¿‘3æ¬¡åŠ¨ä½œã€å½“å‰æˆªå›¾å†³å®šä¸‹ä¸€æ­¥
     - Executor/MCP: æ‰§è¡Œç›¸å…³æ“ä½œ â­ [MCPä¸ºæ–°å¢]
     - æ›´æ–° TaskContextMemory (åŒ…å«MCPç»“æœ)
 â•‘ 4. æ¸…ç†: MCP Client å…³é—­æ‰€æœ‰è¿æ¥ â­ [æ–°å¢]
  ```

#### 2. Planner (planner.py) - ç»Ÿä¸€è§„åˆ’å™¨ â­ æ ¸å¿ƒ
- **èŒè´£**: åˆå§‹è§„åˆ’ + æ‰§è¡Œå†³ç­–ï¼ˆåˆå¹¶äº†åŸæ¥çš„ Planner å’Œ Dispatcherï¼‰
- **ä¸¤ç§æ¨¡å¼**:

  **plan() - åˆå§‹è§„åˆ’æ¨¡å¼**
  - è¾“å…¥: ç”¨æˆ·æŸ¥è¯¢ (user_query)
  - è¾“å‡º: å®Œæ•´çš„æ‰§è¡Œè§„åˆ’
  - è°ƒç”¨æ—¶æœº: ä»»åŠ¡åˆå§‹åŒ–æ—¶

  **dispatch() - æ‰§è¡Œå†³ç­–æ¨¡å¼**
  - è¾“å…¥: æ€»è§„åˆ’ã€æœ€è¿‘næ¬¡åŠ¨ä½œå†å²ã€å½“å‰æˆªå›¾ã€MCPæ‰§è¡Œç»“æœï¼ˆä½œä¸ºå†å²åŠ¨ä½œçš„ä¸€éƒ¨åˆ†ï¼‰
  - è¾“å‡ºåŠ¨ä½œç±»å‹:
    1. **execute** - æ‰§è¡Œå…·ä½“æ“ä½œ (å‚æ•°: executor, action)
    2. **mcp** - æ‰§è¡ŒMCPå·¥å…·è°ƒç”¨ â­ [æ–°å¢] (å‚æ•°: server, tool, params)
    3. **save_info** - ä¿å­˜ä¿¡æ¯åˆ°ä»»åŠ¡è®°å¿† (å‚æ•°: key, value)
    4. **modify_plan** - ä¿®æ”¹æ€»è§„åˆ’ (å‚æ•°: new_plan)
    5. **reply** - ä»»åŠ¡å®Œæˆ
  - è°ƒç”¨æ—¶æœº: å¾ªç¯ä¸­æ¯æ¬¡è¿­ä»£
  - MCPå·¥å…·ä¿¡æ¯: åŠ¨æ€ä»å·²è¿æ¥çš„MCPæœåŠ¡å™¨è·å–ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°Promptä¸­

#### 3. MCP æ¨¡å— (mcp/) â­ **åŸºäºå®˜æ–¹SDK**

##### 3.1 æ¶æ„è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCPClientManager (client.py)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸºäºå®˜æ–¹ mcp>=1.6.0 Python SDK                      â”‚   â”‚
â”‚  â”‚  - ç®¡ç†å¤šä¸ªMCPæœåŠ¡å™¨è¿æ¥ (stdio/SSE)                 â”‚   â”‚
â”‚  â”‚  - åŠ¨æ€å‘ç°å’Œç¼“å­˜æœåŠ¡å™¨å·¥å…·åˆ—è¡¨                      â”‚   â”‚
â”‚  â”‚  - æä¾›ç»Ÿä¸€çš„å·¥å…·è°ƒç”¨æ¥å£                            â”‚   â”‚
â”‚  â”‚  - è‡ªåŠ¨ç”ŸæˆLLMå¯ç”¨çš„å·¥å…·æè¿°                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                  â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Server 1  â”‚  â”‚ MCP Server 2  â”‚  â”‚ MCP Server N  â”‚
â”‚(filesystem)   â”‚  â”‚   (sqlite)    â”‚  â”‚   (github)    â”‚
â”‚               â”‚  â”‚               â”‚  â”‚               â”‚
â”‚ - read_file   â”‚  â”‚ - query       â”‚  â”‚ - create_issueâ”‚
â”‚ - write_file  â”‚  â”‚ - execute     â”‚  â”‚ - get_repo    â”‚
â”‚ - list_dir    â”‚  â”‚ - create_tableâ”‚  â”‚ - search_code â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 3.2 æ ¸å¿ƒç»„ä»¶

**MCPClientManager (client.py)**
- åŸºäºå®˜æ–¹ MCP Python SDK çš„å®¢æˆ·ç«¯åŒ…è£…å™¨
- åŠŸèƒ½:
  - `add_server(name, config)`: å¼‚æ­¥æ·»åŠ å¹¶è¿æ¥MCPæœåŠ¡å™¨
  - `remove_server(name)`: ç§»é™¤æœåŠ¡å™¨è¿æ¥
  - `list_servers()`: åˆ—å‡ºæ‰€æœ‰å·²è¿æ¥çš„æœåŠ¡å™¨
  - `list_tools(server_name)`: åˆ—å‡ºå¯ç”¨å·¥å…·
  - `get_tool_info(server, tool)`: è·å–å·¥å…·è¯¦ç»†ä¿¡æ¯
  - `call_tool(server, tool, params)`: è°ƒç”¨MCPå·¥å…·
  - `close_all()`: å…³é—­æ‰€æœ‰è¿æ¥
  - `get_tools_for_prompt()`: ç”ŸæˆLLMå¯ç”¨çš„å·¥å…·æè¿°

**MCPToolCall (client.py)**
- MCPå·¥å…·è°ƒç”¨æ•°æ®ç±»
- å­—æ®µ:
  - `server_name`: æœåŠ¡å™¨åç§°
  - `tool_name`: å·¥å…·åç§°
  - `arguments`: å·¥å…·å‚æ•°

**MCPToolResult (client.py)**
- MCPå·¥å…·è°ƒç”¨ç»“æœæ•°æ®ç±»
- å­—æ®µ:
  - `success`: æ˜¯å¦æˆåŠŸ
  - `server_name`: æœåŠ¡å™¨åç§°
  - `tool_name`: å·¥å…·åç§°
  - `data`: è¿”å›æ•°æ®
  - `error_message`: é”™è¯¯ä¿¡æ¯

##### 3.3 é…ç½®æ–¹å¼
MCPæœåŠ¡å™¨é€šè¿‡ `mcp_servers` å‚æ•°é…ç½®ï¼š

```python
"mcp_servers": {
    "filesystem": {
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/home/user"],
        "env": {}  # å¯é€‰ç¯å¢ƒå˜é‡
    },
    "sqlite": {
        "command": "python",
        "args": ["-m", "mcp_server_sqlite", "/path/to/db.sqlite"]
    }
}
```

#### 4. Executor (executor.py) - æ‰§è¡Œå™¨
- **èŒè´£**: ç”µè„‘æ“æ§åŠ¨ä½œæ‰§è¡Œ
- **åŠŸèƒ½**: æ¨¡æ‹Ÿé”®ç›˜/é¼ æ ‡äº¤äº’ï¼ˆä½¿ç”¨ grounding æ¨¡å‹ï¼‰ï¼ŒåŒ…æ‹¬ï¼š
  - ç‚¹å‡»æ“ä½œ: å·¦é”®ç‚¹å‡»ã€å³é”®ç‚¹å‡»ã€åŒå‡»ç­‰
  - è¾“å…¥æ“ä½œ: é”®ç›˜è¾“å…¥ã€å¿«æ·é”®
  - ç­‰å¾…æ“ä½œ: ç­‰å¾…é¡µé¢åŠ è½½
  - æ»šåŠ¨æ“ä½œ: ä¸Šä¸‹æ»šåŠ¨
- **è¿”å›**: åŠ¨ä½œæ‰§è¡Œç»“æœ + å±å¹•çŠ¶æ€å˜åŒ–

#### 5. Reply åŠ¨ä½œ - ä»»åŠ¡ç»“æŸ
- **è§¦å‘æ¡ä»¶**: Planner.dispatch() è¿”å› reply åŠ¨ä½œç±»å‹
- **å‚æ•°**:
  - message: éœ€è¦å›å¤ç»™ç”¨æˆ·çš„æ¶ˆæ¯å†…å®¹
- **åŠŸèƒ½**:
  - å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼ŒPlanner è¿”å› reply åŠ¨ä½œ
  - Agent å°† message å†…å®¹å›å¤ç»™ç”¨æˆ·
  - æ ‡è®° is_complete=Trueï¼Œä»»åŠ¡ç»“æŸ

#### 6. TaskContextMemory (memory.py) - ä»»åŠ¡ä¸Šä¸‹æ–‡è®°å¿† â­ **æ‰©å±•**
- **èŒè´£**: å­˜å‚¨å½“å‰ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸Šä¸‹æ–‡ï¼ˆä¸ User Memory åˆ†ç¦»ï¼‰
- **åŠŸèƒ½**:
  - åˆå§‹åŒ–: `TaskContextMemory(task_id, user_query, run_folder)`
  - è®°å½•ä¿¡æ¯:
    - ç”¨æˆ·åŸå§‹è¾“å…¥ (user_query - ä¸å¯å˜)
    - å½“å‰è§„åˆ’ (current_plan - å¯æ›´æ–°)
    - **æ‰€æœ‰å†å²åŠ¨ä½œ**ï¼ˆå®Œæ•´ä¿å­˜ï¼Œè¯»å–æ—¶å¯ç­›é€‰æœ€è¿‘ N æ¡ï¼Œ**åŒ…å«MCPæ‰§è¡Œç»“æœ**ï¼‰â­ [æ‰©å±•]
    - ä¿å­˜çš„é‡è¦ä¿¡æ¯ (saved_info - key-value å­˜å‚¨)
    - å½“å‰æ‰§è¡Œæ­¥éª¤æ•°
    - ä»»åŠ¡çŠ¶æ€
  - ä¿å­˜åˆ° JSON æ–‡ä»¶ï¼š`{run_folder}/memory.json`
  - æä¾›æ–¹æ³•ï¼š
    - `set_plan()`: è®¾ç½®/æ›´æ–°è§„åˆ’
    - `save_info()`: ä¿å­˜å…³é”®ä¿¡æ¯
    - `add_dispatcher_action()`: æ·»åŠ åŠ¨ä½œè®°å½•ï¼ˆMCPç»“æœä½œä¸ºmcpç±»å‹åŠ¨ä½œå­˜å‚¨ï¼‰â­ [æ‰©å±•]
    - `get_recent_actions(n)`: è·å–æœ€è¿‘ N æ¡åŠ¨ä½œï¼ˆåŒ…å«MCPæ‰§è¡Œå†å²ï¼‰
    - `get_all_actions()`: è·å–æ‰€æœ‰åŠ¨ä½œ
    - `get_actions_by_type(type)`: æŒ‰ç±»å‹è·å–åŠ¨ä½œ â­ [æ–°å¢]
    - **MCPç›¸å…³æ–¹æ³•** â­ [æ–°å¢]:
      - `get_mcp_actions()`: è·å–MCPç±»å‹çš„åŠ¨ä½œ
      - `has_mcp_results()`: æ£€æŸ¥æ˜¯å¦æœ‰MCPç»“æœ
      - `get_last_mcp_result()`: è·å–æœ€è¿‘çš„MCPç»“æœ

### å†…å­˜ç³»ç»Ÿå¯¹æ¯”

| ç»´åº¦ | User Memory (server/memory/) | Task Context Memory (agent/memory.py) |
|------|------|------|
| **å­˜å‚¨ä½ç½®** | ç”¨æˆ·æ•°æ®åº“ (SQLite) | Agent å†…å­˜ï¼ˆä»»åŠ¡ç»“æŸæ¸…ç†ï¼‰ |
| **ç”Ÿå‘½å‘¨æœŸ** | è·¨å¤šä¸ªä»»åŠ¡ã€æ°¸ä¹…ä¿å­˜ | å•ä¸ªä»»åŠ¡å†…ã€ä¸´æ—¶å­˜å‚¨ |
| **å†…å®¹** | ç”¨æˆ·å†å²å¯¹è¯ã€äº¤äº’è®°å½• | å½“å‰ä»»åŠ¡çš„æ‰§è¡Œæ­¥éª¤ã€å±å¹•çŠ¶æ€ã€**MCP ç»“æœ** â­ |
| **è®¿é—®æ—¶æœº** | Handlers åŠ è½½ (task å¼€å§‹æ—¶) | Planner ä½¿ç”¨ (loop å†…) |
| **æ›´æ–°æ—¶æœº** | Handlers ä¿å­˜ (task ç»“æŸæ—¶) | Planner æ›´æ–° (æ¯ä¸ªæ­¥éª¤å) |
| **ç”¨é€”** | ç»´æŒå¯¹è¯è¿è´¯æ€§ | æ”¯æŒè§„åˆ’è¿­ä»£å’ŒåŠ¨æ€å†³ç­– |

